<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>聊天畫面</title>
    <link href="/images/Main.css" rel=stylesheet>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.0/jquery.min.js"></script>
</head>
<body>
    <div class="menu" id="menu">
        <div class="GroupSelect" id="GroupSelect">
            <div id="MainIcon">
                <div class="MainIconBackGround" id="MainIconBackGround"></div>
                <div class="StraightLine" id="StraightLine"></div>
                <div class="MainIcon" id="MainIcon" onclick="javascript:window.location.reload()">
                    <div class="DialogBoxContent" id="DialogBoxContent">首頁</div>
                </div>
            </div>
            <div id="GroupButton"></div>
            <div id="CreateGroupButton">
                <div class="CreateGroupIconBackGround" id="CreateGroupIconBackGround"></div>
                <div class="StraightLineForCreateGroup" id="StraightLineForCreateGroup"></div>
                <div class="CreateGroupIcon" id="CreateGroupIcon">
                    <div class="DialogBoxContentForCreateGroup" id="DialogBoxContentForCreateGroup">新增群組</div>
                </div>
            </div>
        </div>
        <div class="MessageChannel"></div>
    </div>
    <div class="content">
        <div class="Banner">
            <input type="button" value="好友" class="Friend" id="Friend">
            <input type="button" value="新增好友" class="CreateFriend" id="CreateFriend">
            <div class="FriendIcon"></div>
        </div>
        <div class="ChatScreen" id="ChatScreen">
            <input type="text"  value="請輸入訊息..." class="InputText" id="TalkWord" onfocus="this.value=''">
            <input type="button" value="" class="TalkSub" id="TalkSub">
            <div class="CreateFriendPage" id="CreateFriendPage">
                <h4>新增好友</h4>
                <h5>&nbsp;&nbsp;&nbsp;&nbsp;您可以在這裡透過輸入好友信箱加入好友列表！</h5>
                <input type="text" value="請輸入好友信箱" class="InputTextCreateFriend" id="InputTextCreateFriend" onfocus="this.value=''">
                <input type="button" value="傳送好友邀請" class="SubInviteFriend" id="SubInviteFriend">
                <div class="HorizontalLine"></div>
            </div>
        </div>
    </div>
</body>
<script type='text/javascript'>
//Group Message Create Basic Function
    var userAccount
    var webSocketList = {}


    var xhr_room = new XMLHttpRequest()
    var xhr_friend = new XMLHttpRequest()
    var xhr_userName = new XMLHttpRequest()
    var xhr_friendInvite = new XMLHttpRequest()
    var xhr_groupInvite = new XMLHttpRequest()

    let ws = new WebSocket('wss://127.0.0.1:3000')


    xhr_room.open("GET", "file/room");

    xhr_room.onload = function () {

        var onLoadMessage = JSON.parse(xhr_room.responseText)
        console.log(onLoadMessage)
        createRoom(onLoadMessage.data)

    };

    xhr_friend.open("GET", "file/friend");

    xhr_friend.onload = function () {

        var onLoadMessage = JSON.parse(xhr_friend.responseText)
        console.log(onLoadMessage)

    };

    xhr_friendInvite.open("GET", "file/friendInvite");

    xhr_friendInvite.onload = function () {

        var onLoadMessage = JSON.parse(xhr_friendInvite.responseText)
        console.log(onLoadMessage)

    };

    xhr_groupInvite.open("GET", "file/groupInvite");

    xhr_groupInvite.onload = function () {

        var onLoadMessage = JSON.parse(xhr_groupInvite.responseText)
        console.log(onLoadMessage)

    };


    xhr_userName.open("GET", "file/userName");

    xhr_userName.onload = function () {

        var onLoadMessage = JSON.parse(xhr_userName.responseText)
        console.log(onLoadMessage)

        webSocketList = {}
        webSocketList["messageName"] = "userAccount"
        webSocketList["data"] = onLoadMessage.data
        sendWebSocket(webSocketList)

    };

    function newMessage(message) {
        var DialogBoxContentForGroup_tab = document.getElementsByClassName("DialogBoxContentForGroup");
        var Talk_tab = document.getElementsByClassName("Talk");
        console.log(message)
        for (x = 0; x < Talk_tab.length; x++) {
            if (DialogBoxContentForGroup_tab[x].innerHTML == message.roomName) {
                Talk_tab[x].innerHTML = Talk_tab[x].innerHTML +
                    '<span>' +
                    message.fromUserAccount +
                    ': ' +
                    message.message +
                    '<br></span>';
            }
        }
    }

    function sendWebSocket(list) {
        var data = JSON.stringify(list)
        ws.send(data)
    }


    function createRoom(roomMessage) {
//Group Select Button
        var GroupButton,r,GroupSelectGetID,GroupButtonID,GroupButtonGetID;
        var MainIconForGroup,MainIconForGroupGetID,DialogBoxContentForGroup,StraightLine;
        var Red,Orange,Yellow,Green,LightBlue,NavyBlue,Purple,RainbowColor=[];
//Get Random for RainbowColor
        function getRandom(min,max){
            return Math.floor(Math.random()*(max-min+1))+min;
        };

        Red = "red"
        Orange = "orange"
        Yellow = "yellow"
        Green = "green"
        LightBlue = "#00FFFF"
        NavyBlue = "blue"
        Purple = "purple"
        RainbowColor = [Red,Orange,Yellow,Green,LightBlue,NavyBlue,Purple];
    

//Start create group button    
        for(r=1; r<= roomMessage.length; r++){
            GroupButtonGetID = document.getElementById("GroupButton");
            GroupButton = document.createElement("div");
            MainIconForGroup = document.createElement("button");
            StraightLine = document.createElement("div");
            GroupButton.className = "GroupIconBackGround";
            GroupButton.id = "GroupIconBackGround" + r;
            GroupButton.style.backgroundColor = RainbowColor[getRandom(0,6)];
            MainIconForGroup.className = "MainIconForGroup";
            MainIconForGroup.id = "MainIconForGroup" + r;
            StraightLine.className = "StraightLineForGroup";
            StraightLine.id = "StraightLineForGroup" + r;
            GroupButtonGetID.appendChild(GroupButton);
            GroupButtonGetID.appendChild(MainIconForGroup);
            GroupButtonGetID.appendChild(StraightLine);

            MainIconForGroupGetID = document.getElementById("MainIconForGroup" + r);
            DialogBoxContentForGroup = document.createElement("div");
            DialogBoxContentForGroup.className = "DialogBoxContentForGroup";
            DialogBoxContentForGroup.id = "DialogBoxContentForGroup" + r;
            DialogBoxContentForGroup.innerHTML = roomMessage[r - 1].RoomName;
            MainIconForGroupGetID.appendChild(DialogBoxContentForGroup);
        }    
    
//Start create GroupName
        var GroupName,MenuGetID;
        for(r=1; r<= roomMessage.length; r++){
            MenuGetID = document.getElementById("menu");
            GroupName = document.createElement("div");
            GroupName.className = "GroupName";
            GroupName.innerHTML = roomMessage[r - 1].RoomName;
            MenuGetID.appendChild(GroupName);
        }

//Start create ChatScreen
        var Talk,ChatScreenGetID;
        for(r=1; r<= roomMessage.length; r++){
            
            ChatScreenGetID = document.getElementById("ChatScreen");
            Talk = document.createElement("div");
            Talk.className = "Talk";
            Talk.id = "Talk";
            ChatScreenGetID.appendChild(Talk);
        }

        var MainIconForGroup_tab = document.getElementsByTagName("button");
        var GroupName_tab = document.getElementsByClassName("GroupName");
        var DialogBoxContentForGroup_tab = document.getElementsByClassName("DialogBoxContentForGroup");
        var StraightLine_tab = document.getElementsByClassName("StraightLineForGroup");
        var GroupButton_tab = document.getElementsByClassName("GroupIconBackGround");
        var Talk_tab = document.getElementsByClassName("Talk");
        var TalkWord = document.getElementById("TalkWord");
        var TalkSub = document.getElementById("TalkSub");
        var x, str = "";
        for (r = 0; r < MainIconForGroup_tab.length; r++) {
            MainIconForGroup_tab[r].index = r;
            MainIconForGroup_tab[r].onclick = function () {
                for (r = 0; r < GroupName_tab.length; r++) {
                    GroupName_tab[r].style.display = "none";
                    StraightLine_tab[r].style.display = "none";
                    Talk_tab[r].style.display = "none";
                }
                GroupName_tab[this.index].style.display = "block";
                StraightLine_tab[this.index].style.display = "block";
                Talk_tab[this.index].style.display = "block";
                TalkWord.style.display = "block";
                $("#CreateFriendPage").css("display","none");
                $("#CreateFriend").css("opacity","1.0");
                x = MainIconForGroup_tab[this.index].index;

                //Mousedown event for CreateFriendPage
                $("#CreateFriend").mousedown(function(){
                    $("#CreateFriend").css("opacity","0.5");
                    $("#CreateFriendPage").css("display","block");
                    Talk_tab[x].style.display = "none";
                    TalkWord.style.display = "none";
                    StraightLine_tab[x].style.display = "none";
                })


                var xhr_oldMessage = new XMLHttpRequest()
                xhr_oldMessage.open("GET", "file/oldMessage/" + DialogBoxContentForGroup_tab[x].innerHTML)
                xhr_oldMessage.onload = function () {

                    var onLoadMessage = JSON.parse(xhr_oldMessage.responseText)
                    Talk_tab[x].innerHTML = ''
                    for (var message_num = 0; message_num < onLoadMessage.data.length; message_num++) {

                        Talk_tab[x].innerHTML += '<span>' +
                            onLoadMessage.data[message_num].UserAccount +
                            ': ' +
                            onLoadMessage.data[message_num].Message +
                            '<br></span>';
                    }
                };
                xhr_oldMessage.send();
            }

            MainIconForGroup_tab[r].onmouseover = function () {
                for (r = 0; r < DialogBoxContentForGroup_tab.length; r++) {
                    DialogBoxContentForGroup_tab[r].style.display = "none";
                }
                DialogBoxContentForGroup_tab[this.index].style.display = "block";
            }
            MainIconForGroup_tab[r].onmouseout = function () {
                DialogBoxContentForGroup_tab[this.index].style.display = "none";
            }

            var flag=false;
            TalkWord.addEventListener("keyup", function (event) {
                if(flag){
		            return;
                }
                flag = true;
                
                if(TalkWord.value == ""){
                        alert("訊息不能為空!")
                        return;
                    }
                else if (event.keyCode === 13) {

                    event.preventDefault();
                    
                    webSocketList["messageName"] = "message"

                    var messagePackage = {}
                    messagePackage["message"] = TalkWord.value
                    messagePackage["roomName"] = DialogBoxContentForGroup_tab[x].innerHTML
                    webSocketList["data"] = messagePackage
                    ws.send(JSON.stringify(webSocketList))
                    TalkWord.value = ""
                }
            });
            document.addEventListener('keyup',function(){
	            flag=false;
            })
        }
    }



    ws.onopen = () => {
        xhr_friend.send();
        xhr_groupInvite.send();
        xhr_friendInvite.send();
        xhr_userName.send();
        xhr_room.send();
        console.log('open connection')
    }

    ws.onclose = () => {
        console.log('close connection')
    }

    ws.onmessage = (data) => {
        console.log(data)
        var parseData = JSON.parse(data.data)
        switch (parseData.messageName) {
            case "message":
                newMessage(parseData.data)
                break;
            default:
                break;
        }
    }

    $(document).ready(function(){
    //Mouseover event for MainIcon
        $("div.MainIcon").mouseover(function(){
            $("div.MainIconBackGround").css("background-color","rgb(141,121,245)");
            $("div.MainIconBackGround").css("border-radius","20px")
            $("div.DialogBoxContent").fadeIn("slow");
            $("div.StraightLine").fadeIn("slow");
        });
        $("div.MainIcon").mouseout(function(){
            $("div.MainIconBackGround").css("background-color","white");
            $("div.MainIconBackGround").css("border-radius","30px")
            $("div.DialogBoxContent").css("display","none");
            $("div.StraightLine").css("display","none");
        });
    //Mouseover event for Friend    
        $("#Friend").mouseover(function(){
            $("#Friend").css("background-color","rgb(120,120,120)");
            $("#Friend").css("color","white");
        });
        $("#Friend").mouseout(function(){
            $("#Friend").css("background-color","transparent");
            $("#Friend").css("color","rgb(211,211,211)");
        })
    //Mouseover event for SubInviteFriend    
        $("#SubInviteFriend").mouseover(function(){
            $("#SubInviteFriend").css("background-color","rgb(73, 41, 235)");
        });
        $("#SubInviteFriend").mouseout(function(){
            $("#SubInviteFriend").css("background-color","rgb(92, 64, 233)");
        })
    //Mousedown event for CreateFriendPage
        $("#CreateFriend").mousedown(function(){
            $("#CreateFriend").css("opacity","0.5");
            $("#CreateFriendPage").css("display","block");
        })
    //Mouseover event for CreateGroupIcon
        $("#CreateGroupIcon").mouseover(function(){
            $("#CreateGroupIconBackGround").css("background-color","rgb(141,121,245)");
            $("#CreateGroupIconBackGround").css("border-radius","20px")
            $("#StraightLineForCreateGroup").fadeIn("slow");
            $("#DialogBoxContentForCreateGroup").fadeIn("slow");
        })
        $("#CreateGroupIcon").mouseout(function(){
            $("#CreateGroupIconBackGround").css("background-color","white");
            $("#CreateGroupIconBackGround").css("border-radius","30px")
            $("#StraightLineForCreateGroup").css("display","none");
            $("#DialogBoxContentForCreateGroup").css("display","none");
        })
    });
</script>

</html>