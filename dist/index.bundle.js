module.exports=function(e){var s={};function r(o){if(s[o])return s[o].exports;var t=s[o]={i:o,l:!1,exports:{}};return e[o].call(t.exports,t,t.exports,r),t.l=!0,t.exports}return r.m=e,r.c=s,r.d=function(e,s,o){r.o(e,s)||Object.defineProperty(e,s,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,s){if(1&s&&(e=r(e)),8&s)return e;if(4&s&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&s&&"string"!=typeof e)for(var t in e)r.d(o,t,function(s){return e[s]}.bind(null,t));return o},r.n=function(e){var s=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(s,"a",s),s},r.o=function(e,s){return Object.prototype.hasOwnProperty.call(e,s)},r.p="",r(r.s=12)}([function(e,s){e.exports=require("express")},function(e,s){e.exports=require("joi")},function(e,s){e.exports=require("mysql")},function(e,s){e.exports=require("jsonwebtoken")},function(e,s){e.exports=require("body-parser")},function(e,s){e.exports=require("cors")},function(e,s){e.exports=require("morgan")},function(e,s){e.exports=require("path")},function(e,s){e.exports=require("cookie-parser")},function(e,s){e.exports=require("ws")},function(e,s){e.exports=require("dotenv")},function(e,s){e.exports=require("http")},function(e,s,r){"use strict";r.r(s);var o=r(1),t=r.n(o);r(10).config();const n=t.a.object().keys({NODE_ENV:t.a.string().default("development").allow(["development","production"]),PORT:t.a.number().default(8080),MYSQL_PORT:t.a.number().default(3306),MYSQL_HOST:t.a.string().default("127.0.0.1"),MYSQL_USER:t.a.string(),MYSQL_PASS:t.a.string(),MYSQL_NAME:t.a.string(),VERSION:t.a.string()}).unknown().required(),{error:c,value:a}=t.a.validate(process.env,n);if(c)throw new Error("Config validation error: "+c.message);var i={version:a.VERSION,env:a.NODE_ENV,port:a.PORT,mysqlPort:a.MYSQL_PORT,mysqlHost:a.MYSQL_HOST,mysqlUserName:a.MYSQL_USER,mysqlPass:a.MYSQL_PASS,mysqlDatabase:a.MYSQL_DATABASE},u=r(0),l=r.n(u),d=r(2),f=r.n(d);const v=f.a.createPool({connection:10,host:i.mysqlHost,user:i.mysqlUserName,password:i.mysqlPass,database:i.mysqlDatabase});var m=e=>new Promise((s,r)=>{v.getConnection((o,t)=>{o?r(o):(t.query("Select UserPassword From account Where UserAccount = ?",e.user_account,(o,t)=>{var n={};o?(console.error("SQL error:",o),n.success="fail",r(o)):t[0].UserPassword===e.user_password?(n.success="success",n.result=t,s(n)):(console.error("SQL error:",o),n.success="fail",r(o))}),t.release())})}),y=r(3),p=r.n(y);var g=e=>new Promise((s,r)=>{p.a.verify(e,"thisismynewproject",(e,r)=>{var o={};e?(console.error("verify error:",e),o.verify="unverify",s(o)):(o.verify="verify",o.payload=r,s(o))})}),S=(e,s)=>new Promise((r,o)=>{const t=p.a.sign({_id:e.toString()},"thisismynewproject",{expiresIn:"1 day"});s.cookie("token",t,{maxAge:1e6,httpOnly:!0,secure:!1}),r("CookieSet")});var h=(e,s)=>{const r=e.body;S(r.user_account,s).then(e=>{"CookieSet"===e?m(r).then(e=>{"success"===e.success?s.redirect("mainPage"):"fail"===e.success&&s.render("Login",{success:!1})}).catch(e=>{s.send(e)}):s.render("Login",{success:!1})}).catch(e=>{s.send(e)})};const q=l.a.Router();q.post("/",(e,s)=>{h(e,s)}),q.get("/",(e,s)=>{s.render("Login")});var b=q;const P=f.a.createPool({connection:10,host:i.mysqlHost,user:i.mysqlUserName,password:i.mysqlPass,database:i.mysqlDatabase});var w={checkAccount:e=>new Promise((s,r)=>{P.getConnection((o,t)=>{o?r(o):(t.query("Select UserPassword From account Where UserAccount = ?",e.user_account,(o,t)=>{var n={};o?(console.error("SQL error:",o),n.success="fail",r(o)):t[0].UserPassword===e.user_password?(n.success="success",n.result=t,s(n)):(console.error("SQL error:",o),n.success="fail",r(o))}),t.release())})})};var O=(e,s)=>{const r=e.body;w.createAccount(r).then(e=>{"success"===e.success?s.redirect("verification"):"fail"===e.success&&s.redirect("register")}).catch(e=>{s.send(e)})};const R=l.a.Router();R.post("/",(e,s)=>{O(e,s)}),R.get("/",(e,s)=>{s.render("Register")});var E=R;var N=(e,s)=>{const r=e.cookies.token;g(r).then(e=>{"verify"===e.verify?s.render("RoomInput"):(e.verify,s.redirect("login"))}).catch(e=>{s.send(e)})},U=(e,s)=>{const r=e.cookies.token;g(r).then(r=>{if("verify"===r.verify){const r=e.body.RoomID;s.render("ChatTest",{RoomID:r})}else r.verify,s.redirect("login")}).catch(e=>{s.send(e)})};const x=l.a.Router();x.post("/",(e,s)=>{U(e,s)}),x.get("/",(e,s)=>{N(e,s)});var L=x;const _=l.a.Router();_.post("/",(e,s)=>{s.render("Verification")});var D=_;const I=f.a.createPool({connection:10,host:i.mysqlHost,user:i.mysqlUserName,password:i.mysqlPass,database:i.mysqlDatabase});var k=e=>new Promise((s,r)=>{I.getConnection((o,t)=>{if(o)r(o);else{var n="INSERT INTO Message(RoomID, FromUserID, Time, Message) VALUES('"+e.roomName+"','"+e.fromUserID+"','98-09-04','"+e.message+"')";t.query(n,(function(e,r){var o={};e?(console.error("SQL error:",e),o.success="fail",s(o)):(o.success="success",o.result=r,s(o))})),t.release()}})});var M=e=>{k(e).then(e=>"success"===e.success||"fail"===e.success?e:void 0).catch(e=>result)};const T=f.a.createPool({connection:10,host:i.mysqlHost,user:i.mysqlUserName,password:i.mysqlPass,database:i.mysqlDatabase});var Q=e=>new Promise((s,r)=>{T.getConnection((o,t)=>{if(o)r(o);else{var n="SELECT RoomID FROM Member WHERE UserID = '"+e.UserID+"'";t.query(n,(function(e,o){var t={};e?(console.error("SQL error:",e),r(e)):(t.success="success",t.result=o,s(t))})),t.release()}})}),C=e=>new Promise((s,r)=>{T.getConnection((o,t)=>{if(o)r(o);else{var n="SELECT UserID1 FROM Friend WHERE UserID2 ='"+e.memberID+"' UNION SELECT UserID2 FROM Friend WHERE UserID1 ='"+e.memberID+"'";t.query(n,(function(e,r){var o={};e?(console.error("SQL error:",e),o.success="fail",s(o)):(o.success="success",o.result=r,s(o))})),t.release()}})}),j=e=>new Promise((s,r)=>{T.getConnection((o,t)=>{if(o)r(o);else{var n="SELECT UserID FROM Account WHERE UserAccount = '"+e._id+"'";t.query(n,(function(e,o){var t={};e?(console.error("SQL error:",e),t.success="fail",r(e)):(t.success="success",t.result=o[0],s(t))})),t.release()}})});var A=(e,s)=>{const r=e.cookies.token;g(r).then(e=>{"verify"===e.verify?j(e.payload).then(e=>{"success"===e.success?Q(e.result).then(e=>{if("success"===e.success){var r={messageName:"userRoom"};r.data=e.result,s.send(JSON.stringify(r))}else e.success}).catch(e=>{s.send(e)}):e.success}).catch(e=>{s.send(e)}):e.verify}).catch(e=>{s.send(e)})},H=(e,s)=>{const r=e.cookies.token;g(r).then(e=>{"verify"===e.verify?j(e.payload).then(e=>{"success"===e.success?(C(e.result).then(e=>{if("success"===e.success){var r={messageName:"userFriend"};r.data=e.result,s.send(JSON.stringify(r))}else e.success}).catch(e=>{s.send(e)}),s.send(JSON.stringify())):e.success}).catch(e=>{s.send(e)}):e.verify}).catch(e=>{s.send(e)})},F=(e,s)=>{const r=e.cookies.token;g(r).then(e=>{if("verify"===e.verify){var r={messageName:"userAccount"};r.data=e.payload._id,s.send(JSON.stringify(r))}else e.verify}).catch(e=>{s.send(e)})};const Y=l.a.Router();Y.get("/room",(function(e,s){A(e,s)})),Y.get("/friend",(function(e,s){H(e,s)})),Y.get("/userName",(function(e,s){F(e,s)}));var J=Y;const V=l.a.Router();V.use("/login",b),V.use("/register",E),V.use("/mainPage",L),V.use("/verification",D),V.use("/file",J);var W=V,$=r(4),z=r.n($),B=r(5),G=r.n(B),K=r(6),X=r.n(K),Z=r(7),ee=r.n(Z),se=r(8),re=r.n(se);const oe=l()();oe.use(z.a.json()),oe.use(z.a.urlencoded({extended:!0})),oe.use(re()()),oe.use(G()()),oe.use(X()("dev")),oe.set("views","./views"),oe.set("view engine","jade"),oe.upload=function(e,s){console.log(e.body)},oe.get("/",(e,s)=>{s.send(`server started express on  port http://127.0.0.1:${i.port} (${i.env})`)}),oe.use("/OnlineText",W),oe.use(l.a.static(ee.a.join("C:/OnlineText/","public"))),oe.use((function(e,s){s.status(404).render("404page")}));var te=oe,ne=r(9),ce=r.n(ne),ae=[];const ie=r(11).createServer(te),ue=new ce.a.Server({server:ie,verifyClient:function(e,s){var r=e.req.headers.cookie,o={};r?(r.split(";").forEach((function(e){var s=e.split("=");o[s.shift().trim()]=decodeURI(s.join("="))})),g(o.token).then(e=>{"verify"===e.verify?s(!0):(e.verify,s(!1,401,"Unauthorized"))}).catch(e=>{console.log(e)})):s(!1,401,"Unauthorized")}});ue.on("connection",e=>{ae.push(e),e.on("message",s=>{var r=JSON.parse(s);switch(r.messageName){case"userAccount":e.id=r.data;break;case"message":r.data.roomName=1,r.data.fromUserID=1;M(r.data);e.send(JSON.stringify(r))}}),e.on("close",()=>{console.log("Close connected");const s=ae.indexOf(e);s>-1&&ae.splice(s,1)})}),ie.listen(i.port,()=>{console.log(`server started on port http://127.0.\n    0.1:${i.port} (${i.env})`)});s.default={app:te,wss:ue}}]);
//# sourceMappingURL=index.bundle.js.map