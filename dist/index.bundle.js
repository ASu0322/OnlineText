module.exports=function(e){var s={};function r(o){if(s[o])return s[o].exports;var t=s[o]={i:o,l:!1,exports:{}};return e[o].call(t.exports,t,t.exports,r),t.l=!0,t.exports}return r.m=e,r.c=s,r.d=function(e,s,o){r.o(e,s)||Object.defineProperty(e,s,{enumerable:!0,get:o})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,s){if(1&s&&(e=r(e)),8&s)return e;if(4&s&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(r.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&s&&"string"!=typeof e)for(var t in e)r.d(o,t,function(s){return e[s]}.bind(null,t));return o},r.n=function(e){var s=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(s,"a",s),s},r.o=function(e,s){return Object.prototype.hasOwnProperty.call(e,s)},r.p="",r(r.s=12)}([function(e,s){e.exports=require("express")},function(e,s){e.exports=require("joi")},function(e,s){e.exports=require("mysql")},function(e,s){e.exports=require("jsonwebtoken")},function(e,s){e.exports=require("body-parser")},function(e,s){e.exports=require("cors")},function(e,s){e.exports=require("morgan")},function(e,s){e.exports=require("path")},function(e,s){e.exports=require("cookie-parser")},function(e,s){e.exports=require("ws")},function(e,s){e.exports=require("dotenv")},function(e,s){e.exports=require("http")},function(e,s,r){"use strict";r.r(s);var o=r(1),t=r.n(o);r(10).config();const n=t.a.object().keys({NODE_ENV:t.a.string().default("development").allow(["development","production"]),PORT:t.a.number().default(8080),MYSQL_PORT:t.a.number().default(3306),MYSQL_HOST:t.a.string().default("127.0.0.1"),MYSQL_USER:t.a.string(),MYSQL_PASS:t.a.string(),MYSQL_NAME:t.a.string(),VERSION:t.a.string()}).unknown().required(),{error:c,value:a}=t.a.validate(process.env,n);if(c)throw new Error("Config validation error: "+c.message);var i={version:a.VERSION,env:a.NODE_ENV,port:a.PORT,mysqlPort:a.MYSQL_PORT,mysqlHost:a.MYSQL_HOST,mysqlUserName:a.MYSQL_USER,mysqlPass:a.MYSQL_PASS,mysqlDatabase:a.MYSQL_DATABASE},u=r(0),l=r.n(u),m=r(2),f=r.n(m);const d=f.a.createPool({connection:10,host:i.mysqlHost,user:i.mysqlUserName,password:i.mysqlPass,database:i.mysqlDatabase});var v=e=>new Promise((s,r)=>{d.getConnection((o,t)=>{if(o)r(o);else{var n="Select UserPassword From account Where UserAccount = '"+e.user_account+"'";t.query(n,(function(o,t){var n={};o?(console.error("SQL error:",o),n.success="fail",r(o)):t[0].UserPassword===e.user_password?(n.success="success",n.result=t,s(n)):(console.error("SQL error:",o),n.success="fail",r(o))})),t.release()}})}),y=r(3),g=r.n(y);var p=e=>new Promise((s,r)=>{g.a.verify(e,"thisismynewproject",(e,r)=>{var o={};e?(console.error("verify error:",e),o.verify="unverify",s(o)):(o.verify="verify",o.payload=r,s(o))})}),h=(e,s)=>new Promise((r,o)=>{const t=g.a.sign({_id:e.toString()},"thisismynewproject",{expiresIn:"1 day"});s.cookie("token",t,{maxAge:1e6,httpOnly:!0,secure:!1}),r("CookieSet")});var S=(e,s)=>{const r=e.body;h(r.user_account,s).then(e=>{"CookieSet"===e?v(r).then(e=>{"success"===e.success?s.redirect("mainPage"):"fail"===e.success&&s.render("Login",{success:!1})}).catch(e=>{s.send(e)}):s.render("Login",{success:!1})}).catch(e=>{s.send(e)})};const R=l.a.Router();R.post("/",(e,s)=>{S(e,s)}),R.get("/",(e,s)=>{s.render("Login")});var N=R;const I=f.a.createPool({connection:10,host:i.mysqlHost,user:i.mysqlUserName,password:i.mysqlPass,database:i.mysqlDatabase});var E=e=>new Promise((s,r)=>{I.getConnection((o,t)=>{if(o)r(o);else{var n="INSERT INTO Account(UserAccount, UserPassword) VALUES('"+e.user_account+"','"+e.user_password+"')";t.query(n,(function(e,r){var o={};e?(console.log(n),console.error("SQL error:",e),o.success="fail",s(o)):(o.success="success",o.result=r,s(o))})),t.release()}})});var q=(e,s)=>{const r=e.body;E(r).then(e=>{"success"===e.success?s.redirect("verification"):"fail"===e.success&&s.redirect("register")}).catch(e=>{s.send(e)})};const O=l.a.Router();O.post("/",(e,s)=>{q(e,s)}),O.get("/",(e,s)=>{s.render("Register")});var U=O;var D=(e,s)=>{const r=e.cookies.token;p(r).then(e=>{"verify"===e.verify?s.render("RoomInput"):(e.verify,s.redirect("login"))}).catch(e=>{s.send(e)})},b=(e,s)=>{const r=e.cookies.token;p(r).then(r=>{if("verify"===r.verify){const r=e.body.RoomID;s.render("GroupChat",{RoomID:r})}else r.verify,s.redirect("login")}).catch(e=>{s.send(e)})};const P=l.a.Router();P.post("/",(e,s)=>{b(e,s)}),P.get("/",(e,s)=>{D(e,s)});var w=P;const L=l.a.Router();L.post("/",(e,s)=>{s.render("Verification")});var M=L;const x=f.a.createPool({connection:10,host:i.mysqlHost,user:i.mysqlUserName,password:i.mysqlPass,database:i.mysqlDatabase});var _=e=>new Promise((s,r)=>{x.getConnection((o,t)=>{if(o)r(o);else{var n="INSERT INTO Message(RoomID, FromUserID, Time, Message) VALUES('"+e.roomID+"','"+e.fromUserID+"','98-09-04','"+e.message+"')";t.query(n,(function(e,r){var o={};e?(console.error("SQL error:",e),o.success="fail",s(o)):(o.success="success",o.result=r,s(o))})),t.release()}})}),C=e=>new Promise((s,r)=>{x.getConnection((o,t)=>{if(o)r(o);else{var n="SELECT account.UserAccount, Message.Message FROM chatroom INNER JOIN message ON chatroom.RoomID = message.RoomID INNER JOIN account ON account.UserID = message.FromUserID WHERE chatroom.RoomName = "+e;t.query(n,(function(e,r){var o={};e?(console.error("SQL error:",e),o.success="fail",s(o)):(o.success="success",o.result=r,s(o))})),t.release()}})});const T=f.a.createPool({connection:10,host:i.mysqlHost,user:i.mysqlUserName,password:i.mysqlPass,database:i.mysqlDatabase});var k={getUserRoom:e=>new Promise((s,r)=>{T.getConnection((o,t)=>{if(o)r(o);else{var n="SELECT chatroom.RoomID, chatroom.Time, member.UserID, chatroom.RoomName FROM member INNER JOIN chatroom ON chatroom.RoomID = member.RoomID WHERE member.UserID = "+e.UserID;t.query(n,(function(e,r){var o={};e?(console.error("SQL error:",e),o.success="fail",s(o)):(o.success="success",o.result=r,s(o))})),t.release()}})}),getUserFriend:e=>new Promise((s,r)=>{T.getConnection((o,t)=>{if(o)r(o);else{var n="SELECT UserID1 FROM Friend WHERE UserID2 ='"+e.memberID+"' UNION SELECT UserID2 FROM Friend WHERE UserID1 ='"+e.memberID+"'";t.query(n,(function(e,r){var o={};e?(console.error("SQL error:",e),o.success="fail",s(o)):(o.success="success",o.result=r,s(o))})),t.release()}})}),getUserName:e=>new Promise((s,r)=>{T.getConnection((o,t)=>{if(o)r(o);else{var n="SELECT UserID FROM Account WHERE UserAccount = '"+e._id+"'";t.query(n,(function(e,o){var t={};e?(console.error("SQL error:",e),t.success="fail",r(e)):(t.success="success",t.result=o[0],s(t))})),t.release()}})}),getUserID:e=>new Promise((s,r)=>{T.getConnection((o,t)=>{if(o)r(o);else{var n="SELECT UserID FROM Account WHERE UserAccount = '"+e+"'";t.query(n,(function(e,o){var t={};e?(console.error("SQL error:",e),t.success="fail",r(e)):(t.success="success",t.result=o[0],s(t))})),t.release()}})})};const Q=f.a.createPool({connection:10,host:i.mysqlHost,user:i.mysqlUserName,password:i.mysqlPass,database:i.mysqlDatabase});var A=e=>new Promise((s,r)=>{Q.getConnection((o,t)=>{if(o)r(o);else{var n="SELECT RoomID FROM ChatRoom WHERE RoomName = '"+e.roomName+"'";t.query(n,(function(e,r){var o={};e?(console.error("SQL error:",e),o.success="fail",s(o)):(o.success="success",o.result=r[0],s(o))})),t.release()}})}),j=e=>new Promise((s,r)=>{Q.getConnection((o,t)=>{if(o)r(o);else{var n="SELECT member.UserID FROM chatroom INNER JOIN member ON chatroom.RoomID = member.RoomID WHERE chatroom.RoomName = '"+e+"'";t.query(n,(function(e,r){var o={};e?(console.error("SQL error:",e),o.success="fail",s(o)):(o.success="success",o.result=r,s(o))})),t.release()}})});var F=e=>new Promise((s,r)=>{j(e).then(e=>{("success"===e.success||"fail"===e.success)&&s(e)}).catch(e=>{s(result)})}),H=e=>new Promise((s,r)=>{A(e).then(r=>{if("success"===r.success)e.roomID=r.result.RoomID,_(e).then(e=>{("success"===e.success||"fail"===e.success)&&s(e)}).catch(e=>{s(r)});else if("fail"===r.success)return r}).catch(e=>result)}),J=e=>new Promise((s,r)=>{C(e).then(e=>{if("success"==e.success){var r={messageName:"getOldMessage"};r.data=e.result,s(r)}else s(e)}).catch(e=>{s(result)})});var Y=(e,s)=>{const r=e.cookies.token;p(r).then(e=>{"verify"===e.verify?k.getUserID(e.payload._id).then(e=>{"success"===e.success?k.getUserRoom(e.result).then(e=>{if("success"===e.success){var r={messageName:"userRoom"};r.data=e.result,s.send(JSON.stringify(r))}else e.success}).catch(e=>{s.send(e)}):"fail"===e.success&&s.redirect("OnlineText")}).catch(e=>{s.send(e)}):"unverify"===e.verify&&s.redirect("login")}).catch(e=>{s.send(e)})},W=(e,s)=>{const r=e.cookies.token;p(r).then(e=>{"verify"===e.verify?k.getName(e.payload).then(e=>{"success"===e.success?(k.getFriend(e.result).then(e=>{if("success"===e.success){var r={messageName:"userFriend"};r.data=e.result,s.send(JSON.stringify(r))}else e.success}).catch(e=>{s.send(e)}),s.send(JSON.stringify())):e.success}).catch(e=>{s.send(e)}):e.verify}).catch(e=>{s.send(e)})},V=(e,s)=>{const r=e.cookies.token;p(r).then(e=>{if("verify"===e.verify){var r={messageName:"userAccount"};r.data=e.payload._id,s.send(JSON.stringify(r))}else e.verify}).catch(e=>{s.send(e)})};const $=l.a.Router();$.get("/room",(function(e,s){Y(e,s)})),$.get("/friend",(function(e,s){W(e,s)})),$.get("/userName",(function(e,s){V(e,s)})),$.get("/oldMessage/:roomName",(function(e,s){J(e.params.roomName).then(e=>{s.send(JSON.stringify(e))}).catch(e=>{console.log(e)})}));var z=$;const B=l.a.Router();B.use("/login",N),B.use("/register",U),B.use("/mainPage",w),B.use("/verification",M),B.use("/file",z);var G=B,K=r(4),X=r.n(K),Z=r(5),ee=r.n(Z),se=r(6),re=r.n(se),oe=r(7),te=r.n(oe),ne=r(8),ce=r.n(ne);const ae=l()();ae.use(X.a.json()),ae.use(X.a.urlencoded({extended:!0})),ae.use(ce()()),ae.use(ee()()),ae.use(re()("dev")),ae.set("views","./views"),ae.set("view engine","jade"),ae.upload=function(e,s){console.log(e.body)},ae.get("/",(e,s)=>{s.send(`server started express on  port http://127.0.0.1:${i.port} (${i.env})`)}),ae.use("/OnlineText",G),ae.use(l.a.static(te.a.join("C:/OnlineText/","public"))),ae.use((function(e,s){s.status(404).render("404page")}));var ie=ae,ue=r(9),le=r.n(ue),me=[];const fe=r(11).createServer(ie),de=new le.a.Server({server:fe,verifyClient:function(e,s){var r=e.req.headers.cookie,o={};r?(r.split(";").forEach((function(e){var s=e.split("=");o[s.shift().trim()]=decodeURI(s.join("="))})),p(o.token).then(e=>{"verify"===e.verify?s(!0):(e.verify,s(!1,401,"Unauthorized"))}).catch(e=>{console.log(e)})):s(!1,401,"Unauthorized")}});de.on("connection",e=>{me.push(e),e.on("message",s=>{var r=JSON.parse(s);switch(r.messageName){case"userAccount":k.getUserID(r.data).then(s=>{"success"===s.success?(e.account=r.data,e.id=s.result.UserID):s.success}).catch(e=>{res.send(e)});break;case"message":r.data.fromUserID=e.id,r.data.fromUserAccount=e.account,H(r.data).then(e=>{"success"===e.success&&F(r.data.roomName).then(e=>{for(var s=0;s<me.length;s++)e.result.some(e=>e.UserID===me[s].id)&&me[s].send(JSON.stringify(r))}).catch(e=>{console.log(e)})}).catch(e=>{console.log(e)})}}),e.on("close",()=>{console.log("Close connected");const s=me.indexOf(e);s>-1&&me.splice(s,1)})}),fe.listen(i.port,()=>{console.log(`server started on port http://127.0.\n    0.1:${i.port} (${i.env})`)});s.default={app:ie,wss:de}}]);
//# sourceMappingURL=index.bundle.js.map