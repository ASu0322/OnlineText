module.exports=function(e){var o={};function r(n){if(o[n])return o[n].exports;var s=o[n]={i:n,l:!1,exports:{}};return e[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=e,r.c=o,r.d=function(e,o,n){r.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,o){if(1&o&&(e=r(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var s in e)r.d(n,s,function(o){return e[o]}.bind(null,s));return n},r.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(o,"a",o),o},r.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},r.p="",r(r.s=14)}([function(e,o){e.exports=require("express")},function(e,o){e.exports=require("mysql")},function(e,o){e.exports=require("joi")},function(e,o){e.exports=require("redis")},function(e,o){e.exports=require("fs")},function(e,o){e.exports=require("jsonwebtoken")},function(e,o){e.exports=require("body-parser")},function(e,o){e.exports=require("https")},function(e,o){e.exports=require("cors")},function(e,o){e.exports=require("morgan")},function(e,o){e.exports=require("path")},function(e,o){e.exports=require("cookie-parser")},function(e,o){e.exports=require("ws")},function(e,o){e.exports=require("dotenv")},function(e,o,r){"use strict";r.r(o);var n=r(3),s=r.n(n),t=r(4),a=r.n(t),c=r(7),i=r.n(c),u=r(2),m=r.n(u);r(13).config();const l=m.a.object().keys({NODE_ENV:m.a.string().default("development").allow(["development","production"]),PORT:m.a.number().default(8080),MYSQL_PORT:m.a.number().default(3306),MYSQL_HOST:m.a.string().default("127.0.0.1"),MYSQL_USER:m.a.string(),MYSQL_PASS:m.a.string(),MYSQL_NAME:m.a.string(),VERSION:m.a.string()}).unknown().required(),{error:d,value:f}=m.a.validate(process.env,l);if(d)throw new Error("Config validation error: "+d.message);var g={version:f.VERSION,env:f.NODE_ENV,port:f.PORT,mysqlPort:f.MYSQL_PORT,mysqlHost:f.MYSQL_HOST,mysqlUserName:f.MYSQL_USER,mysqlPass:f.MYSQL_PASS,mysqlDatabase:f.MYSQL_DATABASE},h=r(0),v=r.n(h);const N=v.a.Router();N.get("/",(e,o)=>{o.render("Login")});var p=N;const I=v.a.Router();I.get("/",(e,o)=>{o.render("Register")});var y=I,S=r(5),R=r.n(S);var E=e=>new Promise((o,r)=>{R.a.verify(e,"thisismynewproject",(e,n)=>{e?(console.error("verify error:",e),r(e)):o(n)})}),O=(e,o)=>new Promise((r,n)=>{const s=R.a.sign({_id:e.toString()},"thisismynewproject",{expiresIn:"1 day"});o.cookie("token",s,{maxAge:1e6,httpOnly:!0,secure:!1}),r("CookieSet")});var D=(e,o)=>{const r=e.cookies.token;E(r).then(e=>{o.render("RoomInput")}).catch(e=>{o.send(e)})},U=(e,o)=>{const r=e.cookies.token;E(r).then(r=>{const n=e.body.RoomID;o.render("GroupChat",{RoomID:n})}).catch(e=>{o.send(e)})};const q=v.a.Router();q.post("/",(e,o)=>{U(e,o)}),q.get("/",(e,o)=>{D(e,o)});var P=q;const w=v.a.Router();w.get("/",(e,o)=>{o.render("Verification")});var A=w,b=r(1),L=r.n(b);const M=L.a.createPool({connection:10,host:g.mysqlHost,user:g.mysqlUserName,password:g.mysqlPass,database:g.mysqlDatabase});var C=(e,o,r)=>new Promise((n,s)=>{M.getConnection((t,a)=>{if(t)s(t);else{var c=new Date,i=c.getFullYear()+"-"+(c.getMonth()+1)+"-"+c.getDate(),u=c.getHours()+":"+c.getMinutes()+":"+c.getSeconds(),m="INSERT INTO Message(RoomID, FromUserID, Time, Message) VALUES('"+e+"','"+o+"','"+(i+" "+u)+"','"+r+"')";a.query(m,(function(e,o){e?(console.error("SQL error:",e),s(e)):n(o)})),n(0),a.release()}})}),k=e=>new Promise((o,r)=>{M.getConnection((n,s)=>{if(n)r(n);else{var t="SELECT account.UserAccount, Message.Message FROM chatroom INNER JOIN message ON chatroom.RoomID = message.RoomID INNER JOIN account ON account.UserID = message.FromUserID WHERE chatroom.RoomName = "+e+" ORDER BY message.MessageID limit 50";s.query(t,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n)})),s.release()}})});const x=L.a.createPool({connection:10,host:g.mysqlHost,user:g.mysqlUserName,password:g.mysqlPass,database:g.mysqlDatabase});var T=e=>new Promise((o,r)=>{x.getConnection((n,s)=>{if(n)r(n);else{var t="SELECT RoomID FROM ChatRoom WHERE RoomName = '"+e+"'";s.query(t,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n[0])})),s.release()}})}),_=e=>new Promise((o,r)=>{x.getConnection((n,s)=>{if(n)r(n);else{var t="SELECT member.UserID FROM chatroom INNER JOIN member ON chatroom.RoomID = member.RoomID WHERE chatroom.RoomName = '"+e+"'";s.query(t,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n)})),s.release()}})});var F=e=>new Promise((o,r)=>{_(e).then(e=>{o(e)}).catch(e=>{r(e)})}),J=e=>new Promise((o,r)=>{T(e.roomName).then(n=>{e.roomID=n.RoomID,C(e.roomID,e.fromUserID,e.message).then(e=>{o(e)}).catch(e=>{r(e)})}).catch(e=>{r(e)})}),Q=e=>new Promise((o,r)=>{const n=s.a.createClient();n.on("connect",()=>{console.log("Redis client connected")}),n.LRANGE(e+"_message",0,50,(s,t)=>{if(0!=t.length){var a={messageName:"getOldMessage"};for(let e=0;e<t.length;e++)t[e]=JSON.parse(t[e]);a.data=t,o(a)}else k(e).then(r=>{var s={messageName:"getOldMessage"};s.data=r;for(var t=0;t<s.data.length;t++)n.RPUSH(e+"_message",JSON.stringify(s.data[t]));o(s)}).catch(e=>{r(e)});if(s)throw console.log(s),s})});const H=L.a.createPool({connection:10,host:g.mysqlHost,user:g.mysqlUserName,password:g.mysqlPass,database:g.mysqlDatabase});var j=e=>new Promise((o,r)=>{H.getConnection((n,s)=>{if(n)r(n);else{var t="SELECT Account.UserAccount FROM Account INNER JOIN friendInvite ON friendInvite.fromUserID = Account.userID WHERE friendInvite.toUserID ="+e;s.query(t,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n)})),s.release()}})}),Y=(e,o)=>new Promise((o,r)=>{H.getConnection((n,s)=>{if(n)r(n);else{var t="DELETE FROM friendInvite WHERE toUserID = "+e+" AND ";s.query(t,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n)})),s.release()}})}),W=(e,o)=>new Promise((r,n)=>{H.getConnection((s,t)=>{if(s)n(s);else{var a="INSERT INTO friendInvite(toUserID, fromUserID) VALUES('"+e+"','"+o+"')";t.query(a,(function(e,o){e?(console.error("SQL error:",e),n(e)):r(o)})),t.release()}})}),V=e=>new Promise((o,r)=>{H.getConnection((n,s)=>{if(n)r(n);else{var t="SELECT ChatRoom.RoomName FROM ChatRoom INNER JOIN groupInvite ON groupInvite.groupID = ChatRoom.RoomID WHERE groupInvite.userID ="+e;s.query(t,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n)})),s.release()}})});const $=L.a.createPool({connection:10,host:g.mysqlHost,user:g.mysqlUserName,password:g.mysqlPass,database:g.mysqlDatabase});var z=e=>new Promise((o,r)=>{$.getConnection((n,s)=>{if(n)r(n);else{var t="SELECT chatroom.RoomID, chatroom.Time, member.UserID, chatroom.RoomName FROM member INNER JOIN chatroom ON chatroom.RoomID = member.RoomID WHERE member.UserID = "+e;s.query(t,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n)})),s.release()}})}),B=e=>new Promise((o,r)=>{$.getConnection((n,s)=>{if(n)r(n);else{var t="SELECT Account.UserAccount FROM Account INNER JOIN Friend ON Friend.UserID2 = Account.UserID WHERE Friend.UserID1 = "+e+" UNION SELECT Account.UserAccount FROM Account INNER JOIN Friend ON Friend.UserID1 = Account.UserID WHERE Friend.UserID2 = "+e;s.query(t,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n)})),s.release()}})}),G=e=>new Promise((o,r)=>{$.getConnection((n,s)=>{if(n)r(n);else{var t="SELECT UserID FROM Account WHERE UserAccount = '"+e+"'";s.query(t,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n[0])})),s.release()}})});var K=(e,o)=>{const r=e.cookies.token;E(r).then(e=>{G(e._id).then(e=>{j(e.UserID).then(e=>{var r={messageName:"friendInvite"};r.data=e,o.send(JSON.stringify(r))}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})},X=(e,o)=>{const r=e.cookies.token;E(r).then(r=>{G(r._id).then(r=>{G(e.params.userName).then(e=>{Y(r.UserID,e.UserID).then(e=>{}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})},Z=(e,o)=>{const r=e.cookies.token;E(r).then(r=>{G(r._id).then(r=>{G(e.params.userName).then(e=>{W(e.UserID,r.UserID).then(e=>{}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})},ee=(e,o)=>{const r=e.cookies.token;E(r).then(e=>{G(e._id).then(e=>{V(e.UserID).then(e=>{var r={messageName:"groupInvite"};r.data=e,o.send(JSON.stringify(r))}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})};var oe=(e,o)=>{const r=e.cookies.token;E(r).then(e=>{G(e._id).then(e=>{z(e.UserID).then(e=>{var r={messageName:"userRoom"};r.data=e,o.send(JSON.stringify(r))}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})},re=(e,o)=>{const r=e.cookies.token;E(r).then(e=>{G(e._id).then(e=>{B(e.UserID).then(e=>{var r={messageName:"userFriend"};r.data=e,o.send(JSON.stringify(r))}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})},ne=(e,o)=>{const r=e.cookies.token;E(r).then(e=>{var r={messageName:"userAccount"};r.data=e._id,o.send(JSON.stringify(r))}).catch(e=>{o.send(e)})};const se=L.a.createPool({connection:10,host:g.mysqlHost,user:g.mysqlUserName,password:g.mysqlPass,database:g.mysqlDatabase});var te=(e,o)=>new Promise((r,n)=>{se.getConnection((s,t)=>{if(s)n(s);else{var a="Select UserPassword From account Where UserAccount = '"+e+"'";t.query(a,(function(e,s){e?(console.error("SQL error:",e),n(e)):0==s.length?r("Account not found"):s[0].UserPassword===o?r("success"):r("Password incorrect")})),t.release()}})});var ae=(e,o)=>{te(e.params.userAccount,e.params.userPassword).then(r=>{if("success"===r)O(e.params.userAccount,o).then(e=>{if("CookieSet"===e){var r={result:"success"};o.send(JSON.stringify(r))}}).catch(e=>{o.send(e)});else{var n={result:"fail"};n.data=r,o.send(JSON.stringify(n))}}).catch(e=>{o.send(e)})};const ce=L.a.createPool({connection:10,host:g.mysqlHost,user:g.mysqlUserName,password:g.mysqlPass,database:g.mysqlDatabase});var ie=(e,o)=>new Promise((r,n)=>{ce.getConnection((s,t)=>{if(s)n(s);else{var a="INSERT INTO Account(UserAccount, UserPassword) VALUES('"+e+"','"+o+"')";t.query(a,(function(e,o){e?(console.error("SQL error:",e),n(e)):r(o)})),t.release()}})});var ue=(e,o)=>{te(e.params.userAccount,e.params.userPassword).then(r=>{if(console.log(r),"Account not found"===r)ie(e.params.userAccount,e.params.userPassword).then(e=>{var r={result:"success"};o.send(JSON.stringify(r))}).catch(e=>{o.send(e)});else if("success"===r||"Password incorrect"===r){var n={result:"fail",data:"Account exist"};o.send(JSON.stringify(n))}console.log("sssss")}).catch(e=>{o.send(e)})};const me=v.a.Router();me.get("/login/:userAccount/:userPassword",(function(e,o){ae(e,o)})),me.post("/register/:userAccount/:userPassword",(function(e,o){ue(e,o)})),me.get("/userName",(function(e,o){ne(e,o)})),me.get("/room",(function(e,o){oe(e,o)})),me.get("/friend",(function(e,o){re(e,o)})),me.get("/groupInvite",(function(e,o){ee(e,o)})),me.post("/groupInvite/:userName/:roomName",(function(e,o){Z(e,o)})),me.delete("/groupInvite/:roomName",(function(e,o){X(e,o)})),me.get("/friendInvite",(function(e,o){K(e,o)})),me.post("/friendInvite/:userName",(function(e,o){Z(e,o)})),me.delete("/friendInvite/:userName",(function(e,o){X(e,o)})),me.get("/oldMessage/:roomName",(function(e,o){Q(e.params.roomName).then(e=>{o.send(JSON.stringify(e))}).catch(e=>{console.log(e)})}));var le=me;const de=v.a.Router();de.use("/login",p),de.use("/register",y),de.use("/mainPage",P),de.use("/verification",A),de.use("/file",le);var fe=de,ge=r(6),he=r.n(ge),ve=r(8),Ne=r.n(ve),pe=r(9),Ie=r.n(pe),ye=r(10),Se=r.n(ye),Re=r(11),Ee=r.n(Re);const Oe=v()();Oe.use(he.a.json()),Oe.use(he.a.urlencoded({extended:!0})),Oe.use(Ee()()),Oe.use(Ne()()),Oe.use(Ie()("dev")),Oe.set("views","./views"),Oe.set("view engine","jade"),Oe.upload=function(e,o){console.log(e.body)},Oe.get("/",(e,o)=>{o.send(`server started express on  port http://127.0.0.1:${g.port} (${g.env})`)}),Oe.use("/OnlineText",fe),Oe.use(v.a.static(Se.a.join("D:/Front-endEngineerLearning/OnlineText/","public"))),Oe.use((function(e,o){o.status(404).render("404page")}));var De=Oe,Ue=r(12),qe=r.n(Ue),Pe=[];const we={key:a.a.readFileSync("key.pem"),cert:a.a.readFileSync("cert.pem")},Ae=i.a.createServer(we,De),be=new qe.a.Server({server:Ae,verifyClient:function(e,o){var r=e.req.headers.cookie,n={};r?(r.split(";").forEach((function(e){var o=e.split("=");n[o.shift().trim()]=decodeURI(o.join("="))})),E(n.token).then(e=>{o(!0)}).catch(e=>{console.log(e),o(!1,401,"Unauthorized")})):o(!1,401,"Unauthorized")}});be.on("connection",e=>{Pe.push(e),e.on("message",o=>{var r=JSON.parse(o);switch(r.messageName){case"userAccount":G(r.data).then(o=>{e.account=r.data,e.id=o.UserID}).catch(e=>{res.send(e)});break;case"message":r.data.fromUserID=e.id,r.data.fromUserAccount=e.account,J(r.data).then(e=>{F(r.data.roomName).then(e=>{const o=s.a.createClient();o.on("connect",()=>{console.log("Redis client connected")});let n={};n.UserAccount=r.data.fromUserAccount,n.Message=r.data.message,o.RPUSH(r.data.roomName+"_message",JSON.stringify(n));for(var t=0;t<Pe.length;t++)e.some(e=>e.UserID===Pe[t].id)&&Pe[t].send(JSON.stringify(r))}).catch(e=>{console.log(e)})}).catch(e=>{console.log(e)})}}),e.on("close",()=>{console.log("Close connected");const o=Pe.indexOf(e);o>-1&&Pe.splice(o,1)})}),Ae.listen(g.port,()=>{console.log(`server started on port https://127.0.\n    0.1:${g.port} (${g.env})`)});o.default={app:De,wss:be}}]);
//# sourceMappingURL=index.bundle.js.map