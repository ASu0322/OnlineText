module.exports=function(e){var o={};function r(n){if(o[n])return o[n].exports;var t=o[n]={i:n,l:!1,exports:{}};return e[n].call(t.exports,t,t.exports,r),t.l=!0,t.exports}return r.m=e,r.c=o,r.d=function(e,o,n){r.o(e,o)||Object.defineProperty(e,o,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,o){if(1&o&&(e=r(e)),8&o)return e;if(4&o&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&o&&"string"!=typeof e)for(var t in e)r.d(n,t,function(o){return e[o]}.bind(null,t));return n},r.n=function(e){var o=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(o,"a",o),o},r.o=function(e,o){return Object.prototype.hasOwnProperty.call(e,o)},r.p="",r(r.s=13)}([function(e,o){e.exports=require("express")},function(e,o){e.exports=require("joi")},function(e,o){e.exports=require("mysql")},function(e,o){e.exports=require("redis")},function(e,o){e.exports=require("jsonwebtoken")},function(e,o){e.exports=require("body-parser")},function(e,o){e.exports=require("cors")},function(e,o){e.exports=require("morgan")},function(e,o){e.exports=require("path")},function(e,o){e.exports=require("cookie-parser")},function(e,o){e.exports=require("ws")},function(e,o){e.exports=require("dotenv")},function(e,o){e.exports=require("http")},function(e,o,r){"use strict";r.r(o);var n=r(3),t=r.n(n),s=r(1),a=r.n(s);r(11).config();const c=a.a.object().keys({NODE_ENV:a.a.string().default("development").allow(["development","production"]),PORT:a.a.number().default(8080),MYSQL_PORT:a.a.number().default(3306),MYSQL_HOST:a.a.string().default("127.0.0.1"),MYSQL_USER:a.a.string(),MYSQL_PASS:a.a.string(),MYSQL_NAME:a.a.string(),VERSION:a.a.string()}).unknown().required(),{error:i,value:u}=a.a.validate(process.env,c);if(i)throw new Error("Config validation error: "+i.message);var m={version:u.VERSION,env:u.NODE_ENV,port:u.PORT,mysqlPort:u.MYSQL_PORT,mysqlHost:u.MYSQL_HOST,mysqlUserName:u.MYSQL_USER,mysqlPass:u.MYSQL_PASS,mysqlDatabase:u.MYSQL_DATABASE},d=r(0),l=r.n(d),g=r(2),f=r.n(g);const h=f.a.createPool({connection:10,host:m.mysqlHost,user:m.mysqlUserName,password:m.mysqlPass,database:m.mysqlDatabase});var I=e=>new Promise((o,r)=>{h.getConnection((n,t)=>{if(n)r(n);else{var s="Select UserPassword From account Where UserAccount = '"+e.user_account+"'";t.query(s,(function(n,t){n?(console.error("SQL error:",n),r(n)):0==t.length?r("Account no found"):t[0].UserPassword===e.user_password?o(t):(console.error("SQL error:",n),r(n))})),t.release()}})}),v=r(4),N=r.n(v);var p=e=>new Promise((o,r)=>{N.a.verify(e,"thisismynewproject",(e,n)=>{e?(console.error("verify error:",e),r(e)):o(n)})}),R=(e,o)=>new Promise((r,n)=>{const t=N.a.sign({_id:e.toString()},"thisismynewproject",{expiresIn:"1 day"});o.cookie("token",t,{maxAge:1e6,httpOnly:!0,secure:!1}),r("CookieSet")});var y=(e,o)=>{const r=e.body;I(r).then(e=>{R(r.user_account,o).then(e=>{"CookieSet"===e?o.redirect("mainPage"):o.render("Login",{success:!1})}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})};const S=l.a.Router();S.post("/",(e,o)=>{y(e,o)}),S.get("/",(e,o)=>{o.render("Login")});var D=S;const U=f.a.createPool({connection:10,host:m.mysqlHost,user:m.mysqlUserName,password:m.mysqlPass,database:m.mysqlDatabase});var E=e=>new Promise((o,r)=>{U.getConnection((n,t)=>{if(n)r(n);else{var s="INSERT INTO Account(UserAccount, UserPassword) VALUES('"+e.user_account+"','"+e.user_password+"')";t.query(s,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n)})),t.release()}})});var O=(e,o)=>{const r=e.body;E(r).then(e=>{o.redirect("verification")}).catch(e=>{o.send(e)})};const q=l.a.Router();q.post("/",(e,o)=>{O(e,o)}),q.get("/",(e,o)=>{o.render("Register")});var P=q;var w=(e,o)=>{const r=e.cookies.token;p(r).then(e=>{o.render("RoomInput")}).catch(e=>{o.send(e)})},b=(e,o)=>{const r=e.cookies.token;p(r).then(r=>{const n=e.body.RoomID;o.render("GroupChat",{RoomID:n})}).catch(e=>{o.send(e)})};const L=l.a.Router();L.post("/",(e,o)=>{b(e,o)}),L.get("/",(e,o)=>{w(e,o)});var C=L;const M=l.a.Router();M.get("/",(e,o)=>{o.render("Verification")});var _=M;const A=f.a.createPool({connection:10,host:m.mysqlHost,user:m.mysqlUserName,password:m.mysqlPass,database:m.mysqlDatabase});var T=e=>new Promise((o,r)=>{A.getConnection((n,t)=>{if(n)r(n);else{var s=new Date,a=s.getFullYear()+"-"+(s.getMonth()+1)+"-"+s.getDate()+" "+(s.getHours()+":"+s.getMinutes()+":"+s.getSeconds()),c="INSERT INTO Message(RoomID, FromUserID, Time, Message) VALUES('"+e.roomID+"','"+e.fromUserID+"','"+a+"','"+e.message+"')";t.query(c,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n)})),o(0),t.release()}})}),k=e=>new Promise((o,r)=>{A.getConnection((n,t)=>{if(n)r(n);else{var s="SELECT account.UserAccount, Message.Message FROM chatroom INNER JOIN message ON chatroom.RoomID = message.RoomID INNER JOIN account ON account.UserID = message.FromUserID WHERE chatroom.RoomName = "+e+" ORDER BY message.MessageID limit 50";t.query(s,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n)})),t.release()}})});const x=f.a.createPool({connection:10,host:m.mysqlHost,user:m.mysqlUserName,password:m.mysqlPass,database:m.mysqlDatabase});var Q=e=>new Promise((o,r)=>{x.getConnection((n,t)=>{if(n)r(n);else{var s="SELECT RoomID FROM ChatRoom WHERE RoomName = '"+e.roomName+"'";t.query(s,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n[0])})),t.release()}})}),F=e=>new Promise((o,r)=>{x.getConnection((n,t)=>{if(n)r(n);else{var s="SELECT member.UserID FROM chatroom INNER JOIN member ON chatroom.RoomID = member.RoomID WHERE chatroom.RoomName = '"+e+"'";t.query(s,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n)})),t.release()}})});var H=e=>new Promise((o,r)=>{F(e).then(e=>{o(e)}).catch(e=>{r(e)})}),J=e=>new Promise((o,r)=>{Q(e).then(n=>{e.roomID=n.RoomID,T(e).then(e=>{o(e)}).catch(e=>{r(e)})}).catch(e=>{r(e)})}),j=e=>new Promise((o,r)=>{const n=t.a.createClient();n.on("connect",()=>{console.log("Redis client connected")}),n.LRANGE(e+"_message",0,50,(t,s)=>{if(0!=s.length){var a={messageName:"getOldMessage"};for(let e=0;e<s.length;e++)s[e]=JSON.parse(s[e]);a.data=s,o(a)}else k(e).then(r=>{var t={messageName:"getOldMessage"};t.data=r;for(var s=0;s<t.data.length;s++)n.RPUSH(e+"_message",JSON.stringify(t.data[s]));o(t)}).catch(e=>{r(e)});if(t)throw console.log(t),t})});const W=f.a.createPool({connection:10,host:m.mysqlHost,user:m.mysqlUserName,password:m.mysqlPass,database:m.mysqlDatabase});var Y=e=>new Promise((o,r)=>{W.getConnection((n,t)=>{if(n)r(n);else{var s="SELECT Account.UserAccount FROM Account INNER JOIN friendInvite ON friendInvite.fromUserID = Account.userID WHERE friendInvite.toUserID ="+e;t.query(s,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n)})),t.release()}})}),V=(e,o)=>new Promise((o,r)=>{W.getConnection((n,t)=>{if(n)r(n);else{var s="DELETE FROM friendInvite WHERE toUserID = "+e+" AND ";t.query(s,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n)})),t.release()}})}),$=(e,o)=>new Promise((r,n)=>{W.getConnection((t,s)=>{if(t)n(t);else{var a="INSERT INTO friendInvite(toUserID, fromUserID) VALUES('"+e+"','"+o+"')";s.query(a,(function(e,o){e?(console.error("SQL error:",e),n(e)):r(o)})),s.release()}})}),z=e=>new Promise((o,r)=>{W.getConnection((n,t)=>{if(n)r(n);else{var s="SELECT ChatRoom.RoomName FROM ChatRoom INNER JOIN groupInvite ON groupInvite.groupID = ChatRoom.RoomID WHERE groupInvite.userID ="+e;t.query(s,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n)})),t.release()}})});const B=f.a.createPool({connection:10,host:m.mysqlHost,user:m.mysqlUserName,password:m.mysqlPass,database:m.mysqlDatabase});var G={getUserRoom:e=>new Promise((o,r)=>{B.getConnection((n,t)=>{if(n)r(n);else{var s="SELECT chatroom.RoomID, chatroom.Time, member.UserID, chatroom.RoomName FROM member INNER JOIN chatroom ON chatroom.RoomID = member.RoomID WHERE member.UserID = "+e.UserID;t.query(s,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n)})),t.release()}})}),getUserFriend:e=>new Promise((o,r)=>{B.getConnection((n,t)=>{if(n)r(n);else{var s="SELECT Friend.UserID1 FROM Account INNER JOIN Friend ON Friend.UserID2 = Account.UserID WHERE member.UserID2 = "+e.UserID+" UNION SELECT Friend.UserID2 FROM Account INNER JOIN Friend ON Friend.UserID1 = Account.UserID WHERE member.UserID1 = "+e.UserID+t.query(s,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n)}));t.release()}})}),getUserName:e=>new Promise((o,r)=>{B.getConnection((n,t)=>{if(n)r(n);else{var s="SELECT UserID FROM Account WHERE UserAccount = '"+e._id+"'";t.query(s,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n[0])})),t.release()}})}),getUserID:e=>new Promise((o,r)=>{B.getConnection((n,t)=>{if(n)r(n);else{var s="SELECT UserID FROM Account WHERE UserAccount = '"+e+"'";t.query(s,(function(e,n){e?(console.error("SQL error:",e),r(e)):o(n[0])})),t.release()}})})};var K=(e,o)=>{const r=e.cookies.token;p(r).then(e=>{G.getUserID(e._id).then(e=>{Y(e.UserID).then(e=>{var r={messageName:"friendInvite"};r.data=e,o.send(JSON.stringify(r))}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})},X=(e,o)=>{const r=e.cookies.token;p(r).then(r=>{G.getUserID(r._id).then(r=>{G.getUserID(e.params.userName).then(e=>{V(r.UserID,e.UserID).then(e=>{}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})},Z=(e,o)=>{const r=e.cookies.token;p(r).then(r=>{G.getUserID(r._id).then(r=>{G.getUserID(e.params.userName).then(e=>{$(e.UserID,r.UserID).then(e=>{}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})},ee=(e,o)=>{const r=e.cookies.token;p(r).then(e=>{G.getUserID(e._id).then(e=>{z(e.UserID).then(e=>{var r={messageName:"groupInvite"};r.data=e,o.send(JSON.stringify(r))}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})};var oe=(e,o)=>{const r=e.cookies.token;p(r).then(e=>{G.getUserID(e._id).then(e=>{G.getUserRoom(e).then(e=>{var r={messageName:"userRoom"};r.data=e,o.send(JSON.stringify(r))}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})},re=(e,o)=>{const r=e.cookies.token;p(r).then(e=>{G.getName(e).then(e=>{G.getFriend(e).then(e=>{var r={messageName:"userFriend"};r.data=e,o.send(JSON.stringify(r))}).catch(e=>{o.send(e)}),o.send(JSON.stringify())}).catch(e=>{o.send(e)})}).catch(e=>{o.send(e)})},ne=(e,o)=>{const r=e.cookies.token;p(r).then(e=>{var r={messageName:"userAccount"};r.data=e._id,o.send(JSON.stringify(r))}).catch(e=>{o.send(e)})};const te=l.a.Router();te.get("/room",(function(e,o){oe(e,o)})),te.get("/userName",(function(e,o){ne(e,o)})),te.get("/friend",(function(e,o){re(e,o)})),te.get("/groupInvite",(function(e,o){ee(e,o)})),te.post("/groupInvite/:userName/:roomName",(function(e,o){Z(e,o)})),te.delete("/groupInvite/:roomName",(function(e,o){X(e,o)})),te.get("/friendInvite",(function(e,o){K(e,o)})),te.post("/friendInvite/:userName",(function(e,o){Z(e,o)})),te.delete("/friendInvite/:userName",(function(e,o){X(e,o)})),te.get("/oldMessage/:roomName",(function(e,o){j(e.params.roomName).then(e=>{o.send(JSON.stringify(e))}).catch(e=>{console.log(e)})}));var se=te;const ae=l.a.Router();ae.use("/login",D),ae.use("/register",P),ae.use("/mainPage",C),ae.use("/verification",_),ae.use("/file",se);var ce=ae,ie=r(5),ue=r.n(ie),me=r(6),de=r.n(me),le=r(7),ge=r.n(le),fe=r(8),he=r.n(fe),Ie=r(9),ve=r.n(Ie);const Ne=l()();Ne.use(ue.a.json()),Ne.use(ue.a.urlencoded({extended:!0})),Ne.use(ve()()),Ne.use(de()()),Ne.use(ge()("dev")),Ne.set("views","./views"),Ne.set("view engine","jade"),Ne.upload=function(e,o){console.log(e.body)},Ne.get("/",(e,o)=>{o.send(`server started express on  port http://127.0.0.1:${m.port} (${m.env})`)}),Ne.use("/OnlineText",ce),Ne.use(l.a.static(he.a.join("C:/OnlineText/","public"))),Ne.use((function(e,o){o.status(404).render("404page")}));var pe=Ne,Re=r(10),ye=r.n(Re),Se=[];const De=r(12).createServer(pe),Ue=new ye.a.Server({server:De,verifyClient:function(e,o){var r=e.req.headers.cookie,n={};r?(r.split(";").forEach((function(e){var o=e.split("=");n[o.shift().trim()]=decodeURI(o.join("="))})),p(n.token).then(e=>{o(!0)}).catch(e=>{console.log(e),o(!1,401,"Unauthorized")})):o(!1,401,"Unauthorized")}});Ue.on("connection",e=>{Se.push(e),e.on("message",o=>{var r=JSON.parse(o);switch(r.messageName){case"userAccount":G.getUserID(r.data).then(o=>{e.account=r.data,e.id=o.UserID}).catch(e=>{res.send(e)});break;case"message":r.data.fromUserID=e.id,r.data.fromUserAccount=e.account,J(r.data).then(e=>{H(r.data.roomName).then(e=>{const o=t.a.createClient();o.on("connect",()=>{console.log("Redis client connected")}),o.RPUSH(r.data.roomName+"_message",JSON.stringify(r.data));for(var n=0;n<Se.length;n++)e.some(e=>e.UserID===Se[n].id)&&Se[n].send(JSON.stringify(r))}).catch(e=>{console.log(e)})}).catch(e=>{console.log(e)})}}),e.on("close",()=>{console.log("Close connected");const o=Se.indexOf(e);o>-1&&Se.splice(o,1)})}),De.listen(m.port,()=>{console.log(`server started on port http://127.0.\n    0.1:${m.port} (${m.env})`)});o.default={app:pe,wss:Ue}}]);
//# sourceMappingURL=index.bundle.js.map